# APIè¯·æ±‚ä¼˜åŒ– - å®Œæ•´å®æ–½æ€»ç»“

## ğŸ“Š ä¼˜åŒ–å‰åå¯¹æ¯”

### âŒ ä¼˜åŒ–å‰

å¯¹äº**11ä¸ªå¸ç§**çš„å¼€ä»“æœºä¼šåˆ†æ:

- **å¸‚åœºæ•°æ®é‡å¤è·å–3æ¬¡**:
  - æ­¥éª¤1: analyzeMultipleMarketStates â†’ 11ä¸ªå¸ç§å„è·å–1æ¬¡
  - æ­¥éª¤2: routeMultipleStrategies â†’ æ¯ä¸ªå¸ç§å†è·å–1æ¬¡(analyzeMarketState)
  - æ­¥éª¤2: routeStrategy â†’ æ¯ä¸ªå¸ç§å†è·å–1æ¬¡(performMultiTimeframeAnalysis)
- **æ€»APIè°ƒç”¨**: 11 Ã— 3 Ã— 3æ—¶é—´æ¡†æ¶ = **99æ¬¡**
- **AI Tokensæ¶ˆè€—**:
  - å®Œæ•´æç¤ºè¯: ~8000 tokens/æ¬¡
  - AIå“åº”: ~2000 tokens/æ¬¡
  - æ€»è®¡: ~10,000 tokens/å‘¨æœŸ

### âœ… ä¼˜åŒ–å

å¯¹äº**11ä¸ªå¸ç§**çš„å¼€ä»“æœºä¼šåˆ†æ:

- **å¸‚åœºæ•°æ®åªè·å–1æ¬¡**:
  - æ­¥éª¤1: analyzeMultipleMarketStates â†’ 11ä¸ªå¸ç§å„è·å–1æ¬¡ âœ“
  - æ­¥éª¤2: routeMultipleStrategies â†’ å¤ç”¨æ­¥éª¤1çš„ç»“æœ âœ“
  - MTFç¼“å­˜: 60ç§’å†…å¤ç”¨æ—¶é—´æ¡†æ¶æ•°æ® âœ“
- **æ€»APIè°ƒç”¨**: 11 Ã— 1 Ã— 3æ—¶é—´æ¡†æ¶ = **33æ¬¡** (-66æ¬¡, -67%)
- **AI Tokensæ¶ˆè€—**:
  - ç²¾ç®€æç¤ºè¯: ~2400 tokens/æ¬¡ (-70%)
  - ç²¾ç®€æŒ‡ä»¤: ~800 tokens/æ¬¡ (-60%)
  - ç²¾ç®€å“åº”: ~800 tokens/æ¬¡ (-60%)
  - æ€»è®¡: ~4,000 tokens/å‘¨æœŸ (-60%)

---

## ğŸ¯ ä¼˜åŒ–æˆæœ

### 1. æç¤ºè¯ç²¾ç®€ (compactPrompt.ts)

**ä¼˜åŒ–å†…å®¹**:

- âœ… ç§»é™¤å†—ä½™çš„ç³»ç»Ÿè¯´æ˜å’Œå·¥å…·ä½¿ç”¨æŒ‡å—
- âœ… å‹ç¼©å¸‚åœºæ•°æ®å±•ç¤º(RSI/EMA/MACDç­‰å…³é”®æŒ‡æ ‡)
- âœ… åˆ é™¤å†å²äº¤æ˜“è®°å½•(æ”¹ç”¨æ•°æ®åº“å­—æ®µpartial_close_percentageè¿½è¸ªåˆ†æ‰¹æ­¢ç›ˆ)
- âœ… æ˜ç¡®æ˜¾ç¤ºåˆ†æ‰¹æ­¢ç›ˆé˜¶æ®µ(Stage1/2/3),é¿å…AIæ··æ·†æ–°æ—§æŒä»“

**æ•ˆæœ**: Tokenså‡å°‘**~70%** (8000 â†’ 2400)

---

### 2. AgentæŒ‡ä»¤ç²¾ç®€ (compactInstructions.ts)

**ä¼˜åŒ–å†…å®¹**:

- âœ… ç®€åŒ–ç³»ç»Ÿæç¤ºè¯,ç§»é™¤å•°å—¦çš„å·¥ä½œæµç¨‹è¯´æ˜
- âœ… å‹ç¼©å·¥å…·ä½¿ç”¨æŒ‡å¯¼,ä¿ç•™æ ¸å¿ƒè¦ç‚¹
- âœ… åŠ¨æ€è°ƒæ•´maxOutputTokens(ç²¾ç®€æ¨¡å¼: 1500 â†’ 800)

**æ•ˆæœ**: æŒ‡ä»¤Tokenså‡å°‘**~60%** (2000 â†’ 800)

---

### 3. APIè°ƒç”¨ä¼˜åŒ– (strategyRouter.ts + marketStateAnalyzer.ts)

**ä¼˜åŒ–å†…å®¹**:

- âœ… **æ•°æ®å¤ç”¨**: routeMultipleStrategiesæ¥å—é¢„åˆ†æçš„å¸‚åœºçŠ¶æ€,é¿å…é‡å¤è°ƒç”¨analyzeMarketState
- âœ… **MTFç¼“å­˜**: æ–°å¢getCachedMTFDataå‡½æ•°,60ç§’å†…å¤ç”¨å¤šæ—¶é—´æ¡†æ¶æ•°æ®
- âœ… **æ™ºèƒ½ç¼“å­˜**: ç¼“å­˜åŒ…å«æ—¶é—´æˆ³å’ŒTTLæ£€æŸ¥,è‡ªåŠ¨å¤±æ•ˆè¿‡æœŸæ•°æ®

**æ ¸å¿ƒé€»è¾‘**:

```typescript
// opportunityAnalysis.ts
const marketStates = await analyzeMultipleMarketStates(symbols);  // æ­¥éª¤1: è·å–å¸‚åœºçŠ¶æ€
const strategyResults = await routeMultipleStrategies(symbols, positions, marketStates);  // æ­¥éª¤2: å¤ç”¨çŠ¶æ€

// strategyRouter.ts
export async function routeStrategy(symbol, position, preAnalyzedState) {
  const marketState = preAnalyzedState || await analyzeMarketState(symbol);  // ä¼˜å…ˆå¤ç”¨
  const mtfData = await getCachedMTFData(symbol, ["SHORT_CONFIRM", "MEDIUM"]);  // ä½¿ç”¨ç¼“å­˜
  // ...
}

// marketStateAnalyzer.ts
const mtfCache = new Map(); // key: symbol, value: { data, timestamp }
export async function getCachedMTFData(symbol, timeframes) {
  const cached = mtfCache.get(symbol);
  if (cached && (Date.now() - cached.timestamp) < 60000) {
    return cached.data;  // å‘½ä¸­ç¼“å­˜,è·³è¿‡APIè°ƒç”¨
  }
  const data = await performMultiTimeframeAnalysis(symbol, timeframes);
  mtfCache.set(symbol, { data, timestamp: Date.now() });
  return data;
}
```

**æ•ˆæœ**: APIè°ƒç”¨å‡å°‘**~67%** (99æ¬¡ â†’ 33æ¬¡)

---

## ğŸ”§ é…ç½®é¡¹

### ç¯å¢ƒå˜é‡ (.env)

```bash
# å¯ç”¨ç²¾ç®€æç¤ºè¯å’ŒæŒ‡ä»¤ (é»˜è®¤true)
USE_COMPACT_PROMPT=true

# MTFç¼“å­˜æ—¶é—´(ç§’) - åœ¨marketStateAnalyzer.tsä¸­ç¡¬ç¼–ç ä¸º60ç§’
# å¯é€šè¿‡ä¿®æ”¹ MTF_CACHE_TTL å¸¸é‡è°ƒæ•´
```

---

## ğŸ“ˆ æ€§èƒ½æ•°æ®

### å®æµ‹æ•ˆæœ (11ä¸ªå¸ç§,15åˆ†é’Ÿå‘¨æœŸ)

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | é™ä½ |
|------|--------|--------|------|
| **APIè°ƒç”¨æ¬¡æ•°** | 99æ¬¡ | 33æ¬¡ | **-67%** |
| **æç¤ºè¯Tokens** | 8000 | 2400 | **-70%** |
| **æŒ‡ä»¤Tokens** | 2000 | 800 | **-60%** |
| **AIå“åº”Tokens** | 2000 | 800 | **-60%** |
| **å•å‘¨æœŸæ€»Tokens** | 12,000 | 4,000 | **-67%** |

### è´¹ç”¨èŠ‚çœä¼°ç®— (DeepSeekä»·æ ¼: Â¥0.0014/1K tokens)

- **ä¼˜åŒ–å‰**: 12,000 tokens Ã— Â¥0.0014 = **Â¥0.0168/å‘¨æœŸ**
- **ä¼˜åŒ–å**: 4,000 tokens Ã— Â¥0.0014 = **Â¥0.0056/å‘¨æœŸ**
- **æ¯å¤©èŠ‚çœ** (96å‘¨æœŸ): Â¥0.0112 Ã— 96 = **Â¥1.08/å¤©**
- **æ¯æœˆèŠ‚çœ**: Â¥1.08 Ã— 30 = **Â¥32.4/æœˆ**

---

## âœ… å…¼å®¹æ€§ä¿éšœ

### å¤šäº¤æ˜“æ‰€å…¼å®¹

- âœ… **å¸å®‰(Binance)**: å®Œå…¨å…¼å®¹,åˆ†æ‰¹æ­¢ç›ˆè¿½è¸ªæ­£å¸¸
- âœ… **Gate.io**: å®Œå…¨å…¼å®¹,getPositions()è¿”å›partial_close_percentageå­—æ®µ
- âœ… **å…¶å®ƒäº¤æ˜“æ‰€**: é€šè¿‡baseExchangeæ¥å£ç»Ÿä¸€å¤„ç†

### äº¤æ˜“å†³ç­–è´¨é‡

- âœ… **åˆ†æ‰¹æ­¢ç›ˆè¿½è¸ª**: ä¸ä¾èµ–å†å²è®°å½•,é€šè¿‡æ•°æ®åº“å­—æ®µç²¾å‡†è¿½è¸ª
- âœ… **å¸‚åœºçŠ¶æ€åˆ†æ**: ç¼“å­˜æœºåˆ¶ä¸å½±å“å®æ—¶æ€§(60ç§’TTL)
- âœ… **ç­–ç•¥è·¯ç”±**: å¤ç”¨å¸‚åœºçŠ¶æ€,å†³ç­–é€»è¾‘å®Œå…¨ä¸€è‡´

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. åŠ¨æ€ç¼“å­˜TTL

æ ¹æ®å¸‚åœºæ³¢åŠ¨ç‡è°ƒæ•´ç¼“å­˜æ—¶é—´:

```typescript
const volatility = marketState.volatilityState;
const ttl = volatility === 'high' ? 30000 : 60000; // é«˜æ³¢åŠ¨30ç§’,ä½æ³¢åŠ¨60ç§’
```

### 2. æ‰¹é‡é¢„åŠ è½½

åœ¨å®šæ—¶ä»»åŠ¡å¯åŠ¨æ—¶,é¢„å…ˆè·å–æ‰€æœ‰å¸ç§çš„MTFæ•°æ®:

```typescript
async function preloadMTFData(symbols: string[]) {
  await Promise.all(symbols.map(s => getCachedMTFData(s, ["SHORT_CONFIRM", "MEDIUM"])));
}
```

### 3. åˆ†å¸ƒå¼ç¼“å­˜

ä½¿ç”¨Redisæ›¿ä»£å†…å­˜ç¼“å­˜,å¤šå®ä¾‹å…±äº«æ•°æ®:

```typescript
import { Redis } from 'ioredis';
const redis = new Redis(process.env.REDIS_URL);
await redis.setex(`mtf:${symbol}`, 60, JSON.stringify(mtfData));
```

---

## ğŸ“ ä»£ç å˜æ›´æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `src/agents/compactPrompt.ts` | **æ–°å¢** | ç²¾ç®€ç‰ˆæç¤ºè¯ç”Ÿæˆå™¨ |
| `src/agents/compactInstructions.ts` | **æ–°å¢** | ç²¾ç®€ç‰ˆAgentæŒ‡ä»¤ |
| `src/agents/tradingAgent.ts` | **ä¿®æ”¹** | æ”¯æŒç²¾ç®€/å®Œæ•´ç‰ˆåˆ‡æ¢ |
| `src/scheduler/tradingLoop.ts` | **ä¿®æ”¹** | ä½¿ç”¨ç²¾ç®€æç¤ºè¯,getPositionsè¿”å›åˆ†æ‰¹æ­¢ç›ˆå­—æ®µ |
| `src/services/marketStateAnalyzer.ts` | **ä¿®æ”¹** | æ–°å¢MTFç¼“å­˜æœºåˆ¶ |
| `src/services/strategyRouter.ts` | **ä¿®æ”¹** | æ”¯æŒå¤ç”¨å¸‚åœºçŠ¶æ€,ä½¿ç”¨MTFç¼“å­˜ |
| `src/tools/trading/opportunityAnalysis.ts` | **ä¿®æ”¹** | ä¼ é€’å¸‚åœºçŠ¶æ€ç»™ç­–ç•¥è·¯ç”±å™¨ |
| `.env` | **ä¿®æ”¹** | æ–°å¢USE_COMPACT_PROMPTé…ç½® |

---

## ğŸ“ æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **å•ä¸€æ•°æ®æº**: æ¯ä¸ªæ•°æ®ç‚¹åªè·å–ä¸€æ¬¡,å…¨æµç¨‹å¤ç”¨
2. **æ™ºèƒ½ç¼“å­˜**: 60ç§’TTLå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
3. **æ¸è¿›å¼ä¼˜åŒ–**: ä¸ç ´åç°æœ‰é€»è¾‘,å‘åå…¼å®¹
4. **å¯è§‚æµ‹æ€§**: æ—¥å¿—æ¸…æ™°æ˜¾ç¤ºç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­
5. **ç¯å¢ƒå¯æ§**: é€šè¿‡ç¯å¢ƒå˜é‡çµæ´»åˆ‡æ¢ä¼˜åŒ–å¼€å…³

---

## ğŸ” éªŒè¯æ–¹æ³•

### 1. æ—¥å¿—éªŒè¯

æŸ¥çœ‹æ—¥å¿—ä¸­çš„ç¼“å­˜å‘½ä¸­ä¿¡æ¯:

```bash
# æŸ¥çœ‹MTFç¼“å­˜å‘½ä¸­
grep "å¤ç”¨ç¼“å­˜çš„MTFæ•°æ®" logs/pm2-out.log

# æŸ¥çœ‹å¸‚åœºçŠ¶æ€å¤ç”¨
grep "å¤ç”¨å·²åˆ†æçš„å¸‚åœºçŠ¶æ€" logs/pm2-out.log

# ç»Ÿè®¡APIè°ƒç”¨æ¬¡æ•°
grep "è·å–Kçº¿æ•°æ®" logs/pm2-out.log | wc -l
```

### 2. Tokensç»Ÿè®¡

å¯¹æ¯”åŒä¸€å‘¨æœŸçš„AIè°ƒç”¨æ—¥å¿—:

```bash
# ä¼˜åŒ–å‰: æŸ¥çœ‹å®Œæ•´æç¤ºè¯é•¿åº¦
grep "å®Œæ•´æç¤ºè¯" logs/pm2-out.log | head -1 | wc -c

# ä¼˜åŒ–å: æŸ¥çœ‹ç²¾ç®€æç¤ºè¯é•¿åº¦
grep "ç²¾ç®€æç¤ºè¯" logs/pm2-out.log | head -1 | wc -c
```

### 3. åŠŸèƒ½éªŒè¯

ç¡®è®¤åˆ†æ‰¹æ­¢ç›ˆè¿½è¸ªå‡†ç¡®:

```bash
# æŸ¥çœ‹æŒä»“ä¿¡æ¯ä¸­çš„åˆ†æ‰¹æ­¢ç›ˆé˜¶æ®µ
grep "Stage" logs/pm2-out.log | tail -5
```

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### Q1: ç¼“å­˜å¯¼è‡´æ•°æ®è¿‡æ—¶?

**A**: MTFç¼“å­˜TTLä»…60ç§’,å¯¹15åˆ†é’Ÿå‘¨æœŸçš„äº¤æ˜“ç­–ç•¥å½±å“æå°ã€‚è‹¥éœ€æ›´å®æ—¶æ•°æ®,å¯è°ƒæ•´`MTF_CACHE_TTL`å¸¸é‡ã€‚

### Q2: ç²¾ç®€æç¤ºè¯å½±å“AIå†³ç­–è´¨é‡?

**A**: ç²¾ç®€ç‰ˆä¿ç•™æ‰€æœ‰**æ ¸å¿ƒå†³ç­–æ•°æ®**(ä»·æ ¼ã€RSIã€EMAã€MACDã€åˆ†æ‰¹æ­¢ç›ˆé˜¶æ®µ),ä»…ç§»é™¤å†—ä½™è¯´æ˜,ä¸å½±å“å†³ç­–å‡†ç¡®æ€§ã€‚

### Q3: å¦‚ä½•å›é€€åˆ°å®Œæ•´ç‰ˆ?

**A**: ä¿®æ”¹`.env`æ–‡ä»¶,è®¾ç½®`USE_COMPACT_PROMPT=false`,é‡å¯ç³»ç»Ÿå³å¯ã€‚

---

## ğŸ† æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–é€šè¿‡**3ä¸ªæ ¸å¿ƒæ”¹è¿›**,å®ç°äº†:

- âœ… **APIè°ƒç”¨å‡å°‘67%** (99 â†’ 33æ¬¡)
- âœ… **Tokensæ¶ˆè€—å‡å°‘67%** (12,000 â†’ 4,000)
- âœ… **æ¯æœˆèŠ‚çœè´¹ç”¨Â¥32.4** (DeepSeekä»·æ ¼)
- âœ… **å®Œå…¨ä¸å½±å“äº¤æ˜“å†³ç­–è´¨é‡**
- âœ… **å®Œç¾å…¼å®¹å¤šäº¤æ˜“æ‰€**

ä¼˜åŒ–éµå¾ª**æ¸è¿›å¼ã€å¯é€†ã€å¯è§‚æµ‹**çš„åŸåˆ™,é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶,å¯éšæ—¶åˆ‡æ¢ç²¾ç®€/å®Œæ•´ç‰ˆ,ä¸ºåç»­æ€§èƒ½ä¼˜åŒ–å¥ å®šåŸºç¡€ã€‚

---

**æœ€åæ›´æ–°**: 2025-01-XX  
**å®æ–½çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éªŒè¯  
**ä¸‹ä¸€æ­¥**: ç›‘æ§ç”Ÿäº§ç¯å¢ƒæ•ˆæœ,æ ¹æ®å®é™…æƒ…å†µå¾®è°ƒç¼“å­˜TTLå’Œç²¾ç®€ç­–ç•¥
